name: ğŸ·ï¸ Create Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
      prerelease:
        description: 'Pre-release'
        default: false
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="v${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: ğŸ“ Generate Changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            echo "## What's New" > CHANGELOG.tmp
            git log --pretty=format:"- %s (%h)" >> CHANGELOG.tmp
          else
            echo "## What's New" > CHANGELOG.tmp
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.tmp
          fi
          
          echo "" >> CHANGELOG.tmp
          echo "## Docker Images" >> CHANGELOG.tmp
          echo "- Backend: \`ghcr.io/${{ github.repository }}/backend:${{ github.sha }}\`" >> CHANGELOG.tmp
          echo "- Website: \`ghcr.io/${{ github.repository }}/website:${{ github.sha }}\`" >> CHANGELOG.tmp
          echo "- Nginx: \`ghcr.io/${{ github.repository }}/nginx:${{ github.sha }}\`" >> CHANGELOG.tmp
          
          cat CHANGELOG.tmp
          
          # For step summary
          echo "## Release Notes" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.tmp >> $GITHUB_STEP_SUMMARY

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.tmp
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: true

      - name: ğŸ“± Trigger Mobile Build
        if: ${{ !github.event.inputs.prerelease }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: build-apk.yml
          token: ${{ secrets.GITHUB_TOKEN }}
          inputs: '{"profile": "production", "platform": "android"}'

  # ==========================================
  # Build Release Assets
  # ==========================================
  build-assets:
    runs-on: ubuntu-latest
    needs: release
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v6

      - name: ğŸ³ Build Docker Images for Release
        run: |
          docker build -t yski-backend:${{ github.ref_name }} ./backend
          docker build -t yski-website:${{ github.ref_name }} ./website
          docker build -t yski-nginx:${{ github.ref_name }} ./nginx

      - name: ğŸ’¾ Save Docker Images
        run: |
          mkdir -p release-assets
          docker save yski-backend:${{ github.ref_name }} | gzip > release-assets/yski-backend-${{ github.ref_name }}.tar.gz
          docker save yski-website:${{ github.ref_name }} | gzip > release-assets/yski-website-${{ github.ref_name }}.tar.gz
          docker save yski-nginx:${{ github.ref_name }} | gzip > release-assets/yski-nginx-${{ github.ref_name }}.tar.gz

      - name: ğŸ“¦ Create Deployment Package
        run: |
          tar -czf release-assets/yski-deployment-${{ github.ref_name }}.tar.gz \
            docker-compose.ip.yml \
            docker-compose.yml \
            docker-compose.prod.yml \
            nginx/ \
            scripts/ \
            .env.example

      - name: â¬†ï¸ Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            release-assets/*.tar.gz
