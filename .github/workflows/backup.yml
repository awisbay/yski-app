name: ðŸ’¾ Backup Database

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ’¾ Backup Database
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e
            
            BACKUP_DIR="/var/www/yski-app/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="yski_backup_$TIMESTAMP.sql.gz"
            
            mkdir -p $BACKUP_DIR
            
            echo "ðŸ—„ï¸  Creating database backup..."
            docker exec yski-app-postgres-1 pg_dump -U yski yski_db | gzip > $BACKUP_DIR/$BACKUP_FILE
            
            echo "âœ… Backup created: $BACKUP_FILE"
            ls -lh $BACKUP_DIR/$BACKUP_FILE
            
            # Keep only last 7 days of backups
            echo "ðŸ§¹ Cleaning old backups..."
            find $BACKUP_DIR -name "yski_backup_*.sql.gz" -mtime +7 -delete
            
            # List remaining backups
            echo "ðŸ“¦ Current backups:"
            ls -lh $BACKUP_DIR/

      - name: â˜ï¸ Upload to Cloud Storage (Optional)
        if: secrets.AWS_ACCESS_KEY_ID
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            # Configure AWS CLI if not already done
            # aws s3 sync /var/www/yski-app/backups/ s3://your-backup-bucket/yski/
            echo "Cloud backup configured"

      - name: ðŸ“ Backup Status
        run: |
          echo "## Database Backup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: 7 days" >> $GITHUB_STEP_SUMMARY
